// Copyright 2023 Developers of the Spimpl project.
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

#[cfg(test)]
mod tests {
    use hex_literal::hex;

    use enr::{NodeId, Record, Scheme, Schemev4, SequenceNumber};

    use crate::packet::{Flag, IdNonce};
    use crate::unpacking::{
        unpack, unpack_handshake_message, unpack_handshake_message_with_record,
        unpack_ordinary_message, unpack_whoareyou, Error,
    };

    #[test]
    fn whoareyou_ok() {
        let test_data = [
            // discv5_whoareyou_packet.py
            ("enr_seq_max", &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a78c034512b1e9472") as &[u8]),
        ];
        for (test_name, packet) in test_data {
            assert!(
                process_whoareyou_packet(&DEST_NODE_ID, packet).is_ok(),
                "{test_name}"
            );
        }
    }

    #[test]
    fn whoareyou_errors() {
        let test_data = [
            // discv5_whoareyou_packet_invalid.py
            ("empty", Error::PacketTooSmall, &hex!("") as &[u8]),
            ("three_bytes", Error::PacketTooSmall, &hex!("010203")),
            ("max_minus_1", Error::PacketTooSmall, &hex!("0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101")),
            ("too_large", Error::PacketTooLarge, &[7; 1281]),
            ("missing_nonce", Error::PacketTooSmall, &hex!("00000000000000000000000000000000088b3d434277464933a0d6c7995f65af136e37f35859922bd1eb48d38495f1efc87667")),
            ("invalid_header_masking", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000891c4888ee89b4cac6019d6ebab88b5b0c3e8b8ed894dcf8e7e2ba558de3fc2a950f35afeb10641ad3f332bb2c482e")),
            ("invalid_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e559e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_dest_node_id", Error::InvalidProtocolId, &hex!("000000000000000000000000000000002901c4a7ff0e8338bb232efb8bd712fbb7d5cd035f103b56b1a67480ce8093aa02fab8673beeba001ab62a78b7c664")),
            ("invalid_masking_iv", Error::InvalidProtocolId, &hex!("07000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_id_nonce", Error::InvalidMessageByteLength, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a803fcbaed4e16b8d2b")),
            ("invalid_enr_seq_2_byte", Error::PacketTooSmall, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873e")),
            ("invalid_enr_seq_9_byte", Error::InvalidMessageByteLength, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d2a")),
            ("invalid_flag_unexpected_value", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497fa1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_flag_2_bytes_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464933edcfc4985864ac126136f0595e9e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_flag_2_bytes_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497fedcfc4985864ac126136f0595e9e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_authdata_size_incorrect_value_a", Error::InvalidMessageByteLength, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528927dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_authdata_size_incorrect_value_b", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e528727dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_authdata_size_1_byte", Error::PacketTooSmall, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e4a9f24dce05dd5839df8e5c37a6a65c90f1a873fcbaed4e16b")),
            ("invalid_authdata_size_3_byte", Error::InvalidMessageByteLength, &hex!("00000000000000000000000000000000088b3d434277464933a1ccc59f5967ad1d6035f15e52863edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_protocol_id_unexpected_value", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d434e75464933a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_protocol_id_shorter", Error::PacketTooSmall, &hex!("00000000000000000000000000000000088b3d433443474930a3cac39d5b69a31f6233fa4a539c25dbe15ed48c9cfbe4c47b6964d61f1a873fcbaed4e1")),
            ("invalid_protocol_id_longer_a", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277737d32a1cfc7995f65af136e37f358599226c7e55ad08090f7e8c07f6d60ca1214882fcbaed4e16b8d2bc3")),
            ("invalid_protocol_id_longer_b", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a1cfc7995f65af136e37f358599226c7e55ad08090f7e8c07f6d60ca1214882fcbaed4e16b8d2bc3")),
            ("invalid_version_unexpected_value", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a33a1ccc59f5967ad1d6035f15e528627dde75cd68292f9e6c27d6b66c8100a873fcbaed4e16b8d")),
            ("invalid_version_shorter", Error::PacketTooSmall, &hex!("00000000000000000000000000000000088b3d434277444933a2cdc29e5a66a21c6334f6524a9f24dce05dd5839df8e5c37a6a65c90f1a873fcbaed4e16b")),
            ("invalid_version_longer_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a1cfc4985864ac126136f0595e9e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_version_longer_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d4342774649cda1cfc4985864ac126136f0595e9e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
            ("invalid_version_longer_c", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a32a1cfc4985864ac126136f0595e9e3edee65bd78193f6e7c17c6c67cb1115973fcbaed4e16b8d2b")),
        ];
        for (test_name, err, packet) in test_data {
            assert_eq!(
                process_whoareyou_packet(&DEST_NODE_ID, packet).unwrap_err(),
                err,
                "{test_name}"
            );
        }
    }

    #[test]
    fn ordinary_message_errors() {
        let test_data = [
            // discv5_ordinary_message_packet_invalid.py
            ("empty", Error::PacketTooSmall, &hex!("") as &[u8]),
            ("three_bytes", Error::PacketTooSmall, &hex!("010203")),
            ("max_minus_1", Error::PacketTooSmall, &hex!("0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101")),
            ("too_large", Error::PacketTooLarge, &[7; 1281]),
            ("missing_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a0ee6c31d87843e1f43f790449d60ea211ca401e18e87bb5fa6993493552d1995415b84102ed931f66d154e433a05b5a2906789a494b842cac1b")),
            ("invalid_header_masking", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000891c4888ee89b4cac7ff6092414272a3fbc87e7a2b94e4534f65a7b97f79f4a0c91f718a98eae689497e2b2f51c420721fa2b9fb2c7348b84102ed931f66d1492acb308fa1c6715b9d139b81acbdcc")),
            ("invalid_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad559e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d2743ed0523f1f6dec48a752db316bb17142114bb694073c")),
            ("invalid_dest_node_id", Error::InvalidProtocolId, &hex!("000000000000000000000000000000002901c4a7ff0e8338baddd307702deb03402338f7ac1003fd1921696c3c1a9b205eeafc4248143893803b33ecca4a6a3b7191b21a2e33c1b84102ed931f66d1492acb308fa1c6715b9d139b81acbdcc")),
            ("invalid_masking_iv", Error::InvalidProtocolId, &hex!("07000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52be8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d1492acb308fa1c6715b9d139b81acbdcc")),
            ("invalid_initiator_key", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52be8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da97cf1dd2a5a9168fc9d07fd625c031400d50bbf230a6df5f")),
            ("invalid_src_node_id", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52be21754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d186a218f32d381ed179185731b5bd619c")),
            ("invalid_flag_unexpected_value", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497f5f313964a39e55ea96c005ad52be8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d1b1a81c50e48bbd73fe2a46fb4da0fb50")),
            ("invalid_flag_2_bytes_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932ed313964a39e55ea96c005adad9e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1321e4edd532f8e3d6434599d8d8efb22")),
            ("invalid_flag_2_bytes_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497fed313964a39e55ea96c005adad9e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1ca9c99bd3805f53fc1830cfd4182bdbe")),
            ("invalid_authdata_size_incorrect_value_a", Error::InvalidAuthDataSize, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52818c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d11ce8412aa46203b36ad6aefc5947db38")),
            ("invalid_authdata_size_incorrect_value_b", Error::InvalidAuthDataSize, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52bf8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d1af4277ba1c1e28f24e860cf8acbc09b1")),
            ("invalid_authdata_size_1_byte", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad72348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642cb84102ed931f66d18412a7c46e065c2646f7cddb87708e02")),
            ("invalid_authdata_size_3_byte", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649325f313964a39e55ea96c005ad52be06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1173a1455cab5dc8892d07581f9dc041e")),
            ("invalid_protocol_id_unexpected_value", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d434e754649325f313964a39e55ea96c005ad52be8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d1ee05d4cc9af3463d80764c32f24c7d9a")),
            ("invalid_protocol_id_shorter", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d43344346b7cd5f313964a39e55ea96c0fa72f834a2c60dac4e8416a7f4805e1a9e548c800a265fd358ef9302018b33bded40b84102ed931f66d108b6061d51879dd6ba874594d7af77d1")),
            ("invalid_protocol_id_longer_a", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277737d32a1ce3964a39e55ea96c005adad6126ff4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428b84102ed931f66d1dd9d41dffbaa20b737396256af023a5a")),
            ("invalid_protocol_id_longer_b", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a1ce3964a39e55ea96c005adad6126ff4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428b84102ed931f66d11a1b4e970906ec7b705f30ca98245cde")),
            ("invalid_version_unexpected_value", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a325f313964a39e55ea96c005ad52be8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08dab84102ed931f66d1cfce60dee9771fafaa15434aa30b991e")),
            ("invalid_version_shorter", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d4342774448cd5f313964a39e55ea96c0055272348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642cb84102ed931f66d16bca8754db8dd39a3b984f1ed4a9c4ff")),
            ("invalid_version_longer_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a0313964a39e55ea96c005adad9e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1c6decc0a3344a4466691eec8ed42f764")),
            ("invalid_version_longer_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d4342774649cda0313964a39e55ea96c005adad9e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1c460da4b1b61f21290dcd6e2226977aa")),
            ("invalid_version_longer_c", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a32a0313964a39e55ea96c005adad9e06754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0b84102ed931f66d1403a67e455927d989719be19cfe5d3b6")),
        ];
        for (test_name, err, packet) in test_data {
            assert_eq!(
                process_ordinary_message_packet(&DEST_NODE_ID, READ_KEY, packet).unwrap_err(),
                err,
                "{test_name}"
            );
        }
    }

    #[test]
    fn handshake_message_errors() {
        let test_data = [
            // discv5_handshake_message_packet_invalid.py
            ("empty", Error::PacketTooSmall, &hex!("") as &[u8]),
            ("three_bytes", Error::PacketTooSmall, &hex!("010203")),
            ("max_minus_1", Error::PacketTooSmall, &hex!("0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101")),
            ("too_large", Error::PacketTooLarge, &[7; 1281]),
            ("missing_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a0ee6c31d87843e1f43f790449d60ea211ca401e18e87bb5fa6993493552d1995415b84102ed931f66d154e433a05b5a2906789a494b842cac1b")),
            ("invalid_header_masking", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000891c4888ee89b4cac5ff6092414272a3fbc87e7a2b9447534f65a7b97f79f4a0c91f718a98eae689497e2b2f51c420721fa2b9fb2c7348b310ac3fb896a7a20f247d0dfbaaafd4cfc8ba129982d59893ed37312cd851ef8f529b854161caa96ba3a4479ed87b9cea07c900c71664a569952143f451b125bb86efa5d33be6df3a6915d05ea3c69c070104d4576d9fefe340d365e238edcddb58aaf1eadf5f0f4126b7e0a2796df0f011d4e40b26d801c7790b")),
            ("invalid_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad559ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd4b5766c13358b2b478985f03e76f6a22a6d118db30db8d65")),
            ("invalid_dest_node_id", Error::InvalidProtocolId, &hex!("000000000000000000000000000000002901c4a7ff0e8338b8ddd307702deb03402338f7ac10a0fd1921696c3c1a9b205eeafc4248143893803b33ecca4a6a3b7191b21a2e33c18b63145574e7eb202d4154dad77e92cd40b4ec373cdbf54a0df7896b8696c312c1385d8e2001eadb7f01856ba913969a2c5b43c6e59ede9753a232f6405b0c74d84599ddc7993258aa8c645b9b6a23b3cb66fabd28a94044518de7f4c52e1708367a31f1eadf5f0f4126b7e0a2796df0f011d4e40b26d801c7790b")),
            ("invalid_masking_iv", Error::InvalidProtocolId, &hex!("07000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7e0a2796df0f011d4e40b26d801c7790b")),
            ("invalid_initiator_key", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef52497cf1dd2a5a9168c2b996f6956e69a61c0582502c78ab73d")),
            ("invalid_src_node_id", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d21754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b7690bbe36b3647997e521e67ad771df22")),
            ("invalid_sig_size_unexpected_value_a", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da34b23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7e41f6eb1f056b9860e3dccf98827594a")),
            ("invalid_sig_size_unexpected_value_b", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4ab23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7be7843693170c789b0de3a9c4c6867f7")),
            ("invalid_sig_size_2_bytes_a", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da0bd3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b787d1ddd0d5eab7c8ae026f06c1030b25")),
            ("invalid_sig_size_2_bytes_b", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4b93b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b758e9d26185bf150ace703904b9af7385")),
            ("invalid_pubkey_size_unexpected_value_a", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb33698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b75c04a357f4319102b95ff3c4458ad615")),
            ("invalid_pubkey_size_unexpected_value_b", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb13698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7e7491723fdb290ae03f659fccd118828")),
            ("invalid_pubkey_size_2_bytes_a", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4b93b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b758e9d26185bf150ace703904b9af7385")),
            ("invalid_pubkey_size_2_bytes_b", Error::EnrDecodingFailed(enr::Error::InvalidPublicKeyData("malformed public key".to_string())), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb2920559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b79e80328663d27e8d244981e6e09ac708")),
            ("invalid_id_signature_shorter", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb236988619d24963bbe78d464b17b78285840e5e33301c62f293132e0dfccece32697c8b7ff1eadf5f0f4126b7cd0ef9d9c694fcf1c9f79e3e22ec6ec4")),
            ("invalid_id_signature_longer", Error::EnrDecodingFailed(enr::Error::InvalidPublicKeyData("malformed public key".to_string())), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f1973530fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b73ce5230dd4e0d31b3bcf130c979ac7c4")),
            ("invalid_eph_pubkey_shorter", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f1973579670f1eadf5f0f4126b78e3e6da929b725bbb93276c8d0589a8e")),
            ("invalid_eph_pubkey_longer", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef5241ff1eadf5f0f4126b7413639d46f2efe49d7af3078cc33322b")),
            ("invalid_flag_unexpected_value", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497f5f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b75d8edde6bc77a7c79e58ce2747645b36")),
            ("invalid_flag_2_bytes_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932ed313964a39e55ea96c005adad9ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b70aa224f1f07f5b6e2780848d3b0c34cc")),
            ("invalid_flag_2_bytes_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497fed313964a39e55ea96c005adad9ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b7de82ff4e42bb9fe8d5e5366f68935076")),
            ("invalid_authdata_size_incorrect_value_a", Error::InvalidAuthDataSize, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7e2f0e29b01c5b9609654511ad3eef882")),
            ("invalid_authdata_size_incorrect_value_b", Error::InvalidAuthDataSize, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521a8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b7ef1fbaad27784ad9bb9761943f1bfdb4")),
            ("invalid_authdata_size_1_byte", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005add1348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642c212a37ab47f902abbc6748eb7aa5f738c47c95d1c12eb95b7ea2214ea4296c3f47047150cc8e13f78aa04d85a03e1cac28025d15c54bfd2942e620d39f1f538dd7b925ce0c4bf728d82ad31947285cd738d79111e31cfd80cae90022b933a986e59203f1eadf5f0f4126b7423489608ac8cf8a690847b1c4686d75")),
            ("invalid_authdata_size_3_byte", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad521da5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b7b663b9a2103a7b6f0dc72044b52db9e0")),
            ("invalid_protocol_id_unexpected_value", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d434e754649305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b70fd7156255cdfbc087978d8d779f8644")),
            ("invalid_protocol_id_shorter", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d43344344b7cd5f313964a39e55ea96c0fad1f834a2c60dac4e8416a7f4805e1a9e548c800a265fd358ef9302018b33bded40d740afaa743878f9bd760d403a5282fb09f048802c3dd15cbd8aacc04a2cbfd5a0a4d698c6a51126c4a2331e802bbc08beffdfdff5af3e6d6916d272af8e12f60577efbc5437d60002e4524c74fef20cb07bd295feb50112eef2191bf719683a993964f1eadf5f0f4126b750295bbc8ea792c18b0ce54161bc026c")),
            ("invalid_protocol_id_longer_a", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277737d32a1cc3964a39e55ea96c005adad61265c4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428d280c423aed040fe43c954293bde75a4c41d3a47bd82553d554f447698f7c1df8861987334138ec56d65e310b1acd3459d7a4302a6e76200e185203334f7345ba15973cb7998cbbdc2cd6352e4d5a3b0530da159245650a6f1875d87ee32c2360e4b35f1eadf5f0f4126b7a70e4e3c23b40684772b3374fe9b4a80")),
            ("invalid_protocol_id_longer_b", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a1cc3964a39e55ea96c005adad61265c4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428d280c423aed040fe43c954293bde75a4c41d3a47bd82553d554f447698f7c1df8861987334138ec56d65e310b1acd3459d7a4302a6e76200e185203334f7345ba15973cb7998cbbdc2cd6352e4d5a3b0530da159245650a6f1875d87ee32c2360e4b35f1eadf5f0f4126b774e15a5d6879cff624e36a645248cb12")),
            ("invalid_version_unexpected_value", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a305f313964a39e55ea96c005ad521d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524f1eadf5f0f4126b792e2d7ec923bce98c97c3547a3a2bdf7")),
            ("invalid_version_shorter", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277444acd5f313964a39e55ea96c00552d1348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642c212a37ab47f902abbc6748eb7aa5f738c47c95d1c12eb95b7ea2214ea4296c3f47047150cc8e13f78aa04d85a03e1cac28025d15c54bfd2942e620d39f1f538dd7b925ce0c4bf728d82ad31947285cd738d79111e31cfd80cae90022b933a986e59203f1eadf5f0f4126b741d979be5ae05ff84fb65314c1a46d16")),
            ("invalid_version_longer_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a2313964a39e55ea96c005adad9ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b726a508557b33dcd834fad765c44a97ee")),
            ("invalid_version_longer_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d4342774649cda2313964a39e55ea96c005adad9ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b7a4326b09b144725d81e8c9e637de4849")),
            ("invalid_version_longer_c", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a32a2313964a39e55ea96c005adad9ea5754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bdf1eadf5f0f4126b754e5a6d419f80394198dc4fa662f5312")),
        ];
        let read_key = hex!("4f9fac6de7567d1e3b1241dffe90f662");
        for (test_name, err, packet) in test_data {
            assert_eq!(
                process_handshake_message_packet::<Schemev4>(&DEST_NODE_ID, &read_key, packet)
                    .unwrap_err(),
                err,
                "{test_name}"
            );
        }
    }

    #[test]
    fn handshake_message_with_record_errors() {
        let test_data = [
            // discv5_handshake_message_packet_invalid.py
            ("empty", Error::PacketTooSmall, &hex!("") as &[u8]),
            ("three_bytes", Error::PacketTooSmall, &hex!("010203")),
            ("max_minus_1", Error::PacketTooSmall, &hex!("0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101")),
            ("too_large", Error::PacketTooLarge, &[7; 1281]),
            ("missing_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464930a1cc6c31d87843e1f43f790449d60ea211ca401e18e87bb5fa6993493552d199541594c0cfb4cd5a7df887c4c23c8737112ede90f6e20eb7e34657d61b37bfea2d79f57eab813fdbca1127dca511b498d2ccf5202ce00216f8481de979bd3caf68fd91f2e05238f1cd0ab1cccf822152faf2e98ba678598ec61aa2341f8cf516c947f1d1b5cc528e4f568a1a65fb4c05ac7c96fe44b73f6bba019b5b126bd2a903d4c79d459b412ab4ad1a832ba04af50482d81a30d75a67e07b26546dfd37694d201236078c5646cef782cf1690be8d164ee73da6d9c5ed0f4aec6cf07357629c1ea795175a6df24459d93719a4ed5f3a7c78f3717dd3ffb48b999d0dbc34b9b0ca8e0b08d65093ccab5aa516452ed1b4acd9d21186753d6d0e20e2")),
            ("invalid_header_masking", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000891c4888ee89b4cac5ff6092414272a3fbc87e7a2b95c6534f65a7b97f79f4a0c91f718a98eae689497e2b2f51c420721fa2b9fb2c7348b310ac3fb896a7a20f247d0dfbaaafd4cfc8ba129982d59893ed37312cd851ef8f529b854161caa96ba3a4479ed87b9cea07c900c71664a569952143f451b125bb86efa5d33be6df3a6915d05ea3c69c070104d4576d9fefe340d365e238edcddb58aa521c7c9deb06072f8a04c9faa60bf6606ae7226cfb6b4384d951a2d2788bdfc00212c4b9d993a11129cea21421885d52c77977f2d6c5aa3edbd23a38bc3cc444877dc482fdfdd046ce5fa0137b10b380334061e347c3533a804a556eea7f0b8632fe23d14724e3d22f81a1fbb4e03f04d0676900ad2930738c65e2cfda175508d65093ccab5aa596a34d7511401987662d8cf62b139471")),
            ("invalid_nonce", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad559f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d394798814c09cba8750ffa9565137ee632625191ef51630face5c8")),
            ("invalid_dest_node_id", Error::InvalidProtocolId, &hex!("000000000000000000000000000000002901c4a7ff0e8338b8ddd307702deb03402338f7ac1121fd1921696c3c1a9b205eeafc4248143893803b33ecca4a6a3b7191b21a2e33c18b63145574e7eb202d4154dad77e92cd40b4ec373cdbf54a0df7896b8696c312c1385d8e2001eadb7f01856ba913969a2c5b43c6e59ede9753a232f6405b0c74d84599ddc7993258aa8c645b9b6a23b3cb66fabd28a94044518de7f4c52e1708367a319da61dd7b906376fc3830d18566e19ad29929af6655b1ac961462a4a5ce218e59edf1b7b11eb7276fe163b74a0c256691abc99b745c56b22c0faa893c532a0374a53377b4fd1dd83e1cf3236b8580410e44393d497e823f80ce100b4c99e70f63a2497378bb97352f96234cdede5c934551d06936b1fc584c1d002a6672d0708d65093ccab5aa596a34d7511401987662d8cf62b139471")),
            ("invalid_masking_iv", Error::InvalidProtocolId, &hex!("07000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa596a34d7511401987662d8cf62b139471")),
            ("invalid_initiator_key", Error::MessageDecryptingFailed, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd297cf1dd2a5a9168c3fb47944d1c6f23b2359ffbfbbf09fa5")),
            ("invalid_src_node_id", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c21754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5ea826e8d96d97cad202c0f150f43a45d")),
            ("invalid_sig_size_unexpected_value_a", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da34b23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa5fec46c55e87d5aacfa4515301f3e6d3b")),
            ("invalid_sig_size_unexpected_value_b", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4ab23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa5cd9471caac2c4ea3d604ade092d8ee93")),
            ("invalid_sig_size_2_bytes_a", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da0bd3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5d80b1f38b3c5681d28cdbcc4fa85f69f")),
            ("invalid_sig_size_2_bytes_b", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4b93b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa55e09fff8078bb4f80e8fb12f262990b9")),
            ("invalid_pubkey_size_unexpected_value_a", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb33698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa53cbc7a49aefd75d0429da5d73daa5f0b")),
            ("invalid_pubkey_size_unexpected_value_b", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb13698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa5aa821430d187ad7e0bfdf79510d9c9fe")),
            ("invalid_pubkey_size_2_bytes_a", Error::EnrDecodingFailed(enr::Error::PublicKeyDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4b93b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa55e09fff8078bb4f80e8fb12f262990b9")),
            ("invalid_pubkey_size_2_bytes_b", Error::EnrDecodingFailed(enr::Error::InvalidPublicKeyData("malformed public key".to_string())), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb2920559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5b3edd683e4d342ad0f880921e468b43b")),
            ("invalid_id_signature_shorter", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb236988619d24963bbe78d464b17b78285840e5e33301c62f293132e0dfccece32697c8b7ff338ff79b563274402885b57d48626608108dab27dc32e1cefa85fbc23781a8ba19c6c0bd676dbbe70858dc574ab2e0b18b6ed8eaf53ec0aa6e9d37754228769942014aec3956adb07026c98f0d337889f437fa220a7857455cc581ebe9da759689dc94570a017b26c2ceceb3540090152cfcea7cc8ce4698b7e3d8d0d0b2e08d65093ccab5aa5512a66a597e07bab0059110b478ba532")),
            ("invalid_id_signature_longer", Error::EnrDecodingFailed(enr::Error::InvalidPublicKeyData("malformed public key".to_string())), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f1973530fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa55102b1b4dc1d963137b4463daa00caa1")),
            ("invalid_eph_pubkey_shorter", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f1973579670a9041b2dfb583a2f63a402202acc95b9e0d0d6572097a5fcb59cd95bd1f5724a64bcd418e63e904fe6a1f4d3a4e5f33aff1d81c68b414546b4e4ebbfa0b52b715d4c34ffa4dab25051bb793612ec715721d29a2ade8c9570944724a388352484689bc825c4fd1ae8aee119f2fd420e261650e625c6de956ded14f0b89e866c08d65093ccab5aa574b7c6fbc7def0121c17c2f02b6e5d69")),
            ("invalid_eph_pubkey_longer", Error::EnrDecodingFailed(enr::Error::RlpDecodingError(rlp::Error::ItemDataWithInvalidByteLength)), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef5241f68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa57f84262478779fbff059f54d59ddecdf")),
            ("invalid_flag_unexpected_value", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497f5f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa56371c7d9bbe07e5cddf7003c0b8a6459")),
            ("invalid_flag_2_bytes_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932ed313964a39e55ea96c005adad9f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5d828b2600e6752c7873cf9762ff80e1e")),
            ("invalid_flag_2_bytes_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d43427746497fed313964a39e55ea96c005adad9f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa51f274b900929ca307e5bd476d531f0cb")),
            ("invalid_authdata_size_incorrect_value_a", Error::EnrDecodingFailed(enr::Error::RlpDecodingError(rlp::Error::ItemDataWithInvalidByteLength)), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539f8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa56d83c7a9b611ab50f09f3d3d23b75423")),
            ("invalid_authdata_size_incorrect_value_b", Error::EnrDecodingFailed(enr::Error::RlpDecodingError(rlp::Error::ItemDataWithInvalidByteLength)), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539d8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa5c04334c1738f77ca1443e3b0d3702bbf")),
            ("invalid_authdata_size_1_byte", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005adad348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642c212a37ab47f902abbc6748eb7aa5f738c47c95d1c12eb95b7ea2214ea4296c3f47047150cc8e13f78aa04d85a03e1cac28025d15c54bfd2942e620d39f1f538dd7b925ce0c4bf728d82ad31947285cd738d79111e31cfd80cae90022b933a986e59203796528fc94344ffa539aa092e1721addfb63518f89db9abc4c48559e108d04af5703a5add6235fe901ffb4587331e4f29477ea997289240d59751277a728df6c83d27c9ed85bac88044fbd8de931e62bf72f071f77ee4c939644947f49a48f147b97dc327986a4f31fcfbbe96bf0796c0407cfb808b8906e0fe4eac60d951908d65093ccab5aa5d6643371c577c8267b0c894a8fbdaa68")),
            ("invalid_authdata_size_3_byte", Error::EnrDecodingFailed(enr::Error::SignatureDataWithInvalidByteLength), &hex!("00000000000000000000000000000000088b3d4342774649305f313964a39e55ea96c005ad539c26754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5ae76cfe19bf510a6c2730419dfaa8e62")),
            ("invalid_protocol_id_unexpected_value", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d434e754649305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa51668a163b28f60987117faf63239a169")),
            ("invalid_protocol_id_shorter", Error::InvalidProtocolId, &hex!("00000000000000000000000000000000088b3d43344344b7cd5f313964a39e55ea96c0fb50f834a2c60dac4e8416a7f4805e1a9e548c800a265fd358ef9302018b33bded40d740afaa743878f9bd760d403a5282fb09f048802c3dd15cbd8aacc04a2cbfd5a0a4d698c6a51126c4a2331e802bbc08beffdfdff5af3e6d6916d272af8e12f60577efbc5437d60002e4524c74fef20cb07bd295feb50112eef2191bf719683a9939645efca0d0ab62658c184fb42edb83369f785941cbe107a7e934d9717c731393b4adb03d4325455894fc7c5bbf6db11d3d731e379081c01c031d6ae4d17348051dae61ccb0b85bb0a16ef00d0b66f0c51d54f72e8fe561e85fd19147c925d9069fd6e8c42dfa2adee633dff673d0776478ccd03ea8975726bb589a7d2b6bb80008d65093ccab5aa55a3900d0a0120f7c4ab4f28d96b4bb04")),
            ("invalid_protocol_id_longer_a", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277737d32a1cc3964a39e55ea96c005adad6127dd4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428d280c423aed040fe43c954293bde75a4c41d3a47bd82553d554f447698f7c1df8861987334138ec56d65e310b1acd3459d7a4302a6e76200e185203334f7345ba15973cb7998cbbdc2cd6352e4d5a3b0530da159245650a6f1875d87ee32c2360e4b3544fe6dbf9e23a7702e08d7757e9fe174955fa1063dcb26711bed4af402fb567e9286de3fcaa45c788ae9cd3fc5e0a5a12950591b0dfb71a016f100196cae3042ae2c32e2ed0450ed8df675e03d87ab7996048aa690c112d2264d33e7360bd6de0313ec67bac58d82d8a31dc8e53172823279af7e848c6cd00bf84c94f20d5408d65093ccab5aa5553ec387aab62cf31afc66251fa864bf")),
            ("invalid_protocol_id_longer_b", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a1cc3964a39e55ea96c005adad6127dd4ef2579d7c0572c8f531708e376772ad583459f8fff0a7cd9d9458b3c1c79428d280c423aed040fe43c954293bde75a4c41d3a47bd82553d554f447698f7c1df8861987334138ec56d65e310b1acd3459d7a4302a6e76200e185203334f7345ba15973cb7998cbbdc2cd6352e4d5a3b0530da159245650a6f1875d87ee32c2360e4b3544fe6dbf9e23a7702e08d7757e9fe174955fa1063dcb26711bed4af402fb567e9286de3fcaa45c788ae9cd3fc5e0a5a12950591b0dfb71a016f100196cae3042ae2c32e2ed0450ed8df675e03d87ab7996048aa690c112d2264d33e7360bd6de0313ec67bac58d82d8a31dc8e53172823279af7e848c6cd00bf84c94f20d5408d65093ccab5aa5dd4fe9df652b485ad726a6eebd92fe60")),
            ("invalid_version_unexpected_value", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a305f313964a39e55ea96c005ad539c8c7560413a7008f16c9e6d2f43bbea8814a546b7409ce783d34c4f53245d08da4bb23698868350aaad22e3ab8dd034f548a1c43cd246be98562fafa0a1fa86d8e7a3b95ae78cc2b988ded6a5b59eb83ad58097252188b902b21481e30e5e285f19735796706adff216ab862a9186875f9494150c4ae06fa4d1f0396c93f215fa4ef524e0ed04c3c21e39b1868e1ca8105e585ec17315e755e6cfc4dd6cb7fd8e1a1f55e49b4b5eb024221482105346f3c82b15fdaae36a3bb12a494683b4a3c7f2ae41306252fed84785e2bbff3b022812d0882f06978df84a80d443972213342d04b9048fc3b1d5fcb1df0f822152eced6da4d3f6df27e70e4539717307a0208cd208d65093ccab5aa59769bf8e08c0a3e4855ca341531a17c8")),
            ("invalid_version_shorter", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277444acd5f313964a39e55ea96c0055350348c5bfdb127199572b9d33e4f16338d891db2d23aa96d6575a4e92d4dd4642c212a37ab47f902abbc6748eb7aa5f738c47c95d1c12eb95b7ea2214ea4296c3f47047150cc8e13f78aa04d85a03e1cac28025d15c54bfd2942e620d39f1f538dd7b925ce0c4bf728d82ad31947285cd738d79111e31cfd80cae90022b933a986e59203796528fc94344ffa539aa092e1721addfb63518f89db9abc4c48559e108d04af5703a5add6235fe901ffb4587331e4f29477ea997289240d59751277a728df6c83d27c9ed85bac88044fbd8de931e62bf72f071f77ee4c939644947f49a48f147b97dc327986a4f31fcfbbe96bf0796c0407cfb808b8906e0fe4eac60d951908d65093ccab5aa5892c31619fd79ec7059a58b103f6538a")),
            ("invalid_version_longer_a", Error::InvalidAuthDataBytes, &hex!("00000000000000000000000000000000088b3d434277464932a2313964a39e55ea96c005adad9f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5ee8d60eaa2cdf2a05c8723fae5d897ee")),
            ("invalid_version_longer_b", Error::InvalidFlag, &hex!("00000000000000000000000000000000088b3d4342774649cda2313964a39e55ea96c005adad9f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5073f9242c24a55cd7602cf7d26c240b6")),
            ("invalid_version_longer_c", Error::InvalidVersion, &hex!("00000000000000000000000000000000088b3d434277464a32a2313964a39e55ea96c005adad9f24754edcca6d616cef4b207c23ee62ef15ac5123cd751601253bea313aad31feb0d3b30559fcd151bbe889a35cf813f97995f0292fba417db0dba141a572106178406bb371e55d8cbbf645f6b0153a2ec7574aa7c1e2cc92f240b5b1724f25fa91d3010fea5142053c97feb5fc3f5d0ff3d71008a5b6724bbfc8c97746524e695129d2bd68c13b95e8687264923226593c1cdb64d1377d3b68b3b755f98ed4631901e5e67c75b838b759df976df74dc60a07cc7c20a3102303bf6e56b02560c31d8383f2804c32fec46eef5d0b79b4c30b247350069605025c86c70190214e6ebda6a9c61c90401dafe99dcf42189ad5f1f9a57322e640c851db1247e69e618d39479808d65093ccab5aa5ef479211bb4d48c3bff60c4d9dd11457")),
        ];
        let read_key = hex!("53b1c075f41876423154e157470c2f48");
        for (test_name, err, packet) in test_data {
            assert_eq!(
                process_handshake_message_with_record_packet::<Schemev4>(
                    &DEST_NODE_ID,
                    &read_key,
                    packet
                )
                .unwrap_err(),
                err,
                "{test_name}"
            );

            // let mut key_data =
            //     hex!("66fb62bfbd66b9177a138c1e5cddbe4f7c30c343e94e68df8769459cb1cde628");
            // let node_key_2 =
            //     sigp_discv5::enr::CombinedKey::secp256k1_from_bytes(&mut key_data).unwrap();
            // let dst_id: sigp_discv5::enr::NodeId =
            //     <sigp_discv5::enr::CombinedKey as sigp_discv5::enr::EnrKey>::public(&node_key_2)
            //         .into();
            // assert!(
            //     sigp_discv5::packet::Packet::decode::<sigp_discv5::DefaultProtocolId>(
            //         &dst_id, packet
            //     )
            //     .is_err(),
            //     "{test_name}"
            // );
        }
    }

    const DEST_NODE_ID: NodeId = NodeId(hex!(
        "bbbb9d047f0488c0b5a93c1c3f2d8bafc7c8ff337024a55434a0d0555de64db9"
    ));
    const READ_KEY: &[u8; 16] = &hex!("00000000000000000000000000000000");

    fn process_whoareyou_packet(
        dest_node_id: &NodeId,
        bytes: &[u8],
    ) -> Result<(IdNonce, SequenceNumber), Error> {
        let (_, flag, _, static_header, auth_data, encrypted_message_data) =
            unpack(dest_node_id, bytes)?;
        if flag != Flag::Whoareyou {
            return Err(Error::InvalidFlag);
        }

        unpack_whoareyou(&static_header, &auth_data, encrypted_message_data)
    }

    fn process_ordinary_message_packet(
        dest_node_id: &NodeId,
        read_key: &[u8; 16],
        bytes: &[u8],
    ) -> Result<(NodeId, Vec<u8>), Error> {
        let (masking_iv, flag, nonce, static_header, auth_data, encrypted_message_data) =
            unpack(&dest_node_id, &bytes)?;
        if flag != Flag::OrdinaryMessage {
            return Err(Error::InvalidFlag);
        }

        unpack_ordinary_message(
            &masking_iv,
            read_key,
            &nonce,
            &static_header,
            &auth_data,
            encrypted_message_data,
        )
    }

    fn process_handshake_message_packet<S: Scheme>(
        dest_node_id: &NodeId,
        read_key: &[u8; 16],
        bytes: &[u8],
    ) -> Result<(NodeId, S::Signature, S::PublicKey, Vec<u8>), Error> {
        let (masking_iv, flag, nonce, static_header, auth_data, encrypted_message_data) =
            unpack(&dest_node_id, &bytes)?;
        if flag != Flag::HandshakeMessage {
            return Err(Error::InvalidFlag);
        }

        unpack_handshake_message::<S>(
            &masking_iv,
            &read_key,
            &nonce,
            &static_header,
            &auth_data,
            encrypted_message_data,
        )
    }

    fn process_handshake_message_with_record_packet<S: Scheme>(
        dest_node_id: &NodeId,
        read_key: &[u8; 16],
        bytes: &[u8],
    ) -> Result<(NodeId, S::Signature, S::PublicKey, Record, Vec<u8>), Error> {
        let (masking_iv, flag, nonce, static_header, auth_data, encrypted_message_data) =
            unpack(&dest_node_id, &bytes)?;
        if flag != Flag::HandshakeMessage {
            return Err(Error::InvalidFlag);
        }

        unpack_handshake_message_with_record::<S>(
            &masking_iv,
            &read_key,
            &nonce,
            &static_header,
            &auth_data,
            encrypted_message_data,
        )
    }
}
